<!DOCTYPE html>
<html style="height: 100%;">
<head>
  <title>Interactive Map</title>
  {% load static %}
  <link rel="stylesheet" href="{% static 'css/maptabs.css' %}">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="{% static 'css/Heading.css' %}">
</head>

<body>
  {% include "HTML/navbar.html" %}
<style>
  .graph-slot { margin-top: 16px; }
  .graph-frame {
    display: block;
    width: 100%;
    min-height: 700px;   /* initial height */
    border: 0;
    border-radius: 8px;
  }
  @media (min-width: 1200px) {
    .graph-frame { min-height: 820px; }
  }
</style>


<script>
document.addEventListener('DOMContentLoaded', () => {
  const today = new Date(); today.setHours(0,0,0,0);
  const normDate = v => { const d = new Date(v); d.setHours(0,0,0,0); return d; };
  const isoDate = d => {
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  };

  // --- Tunables ------------------------------------------------------------
  const ENABLE_PROBE = true;
  const TREAT_ALL_500_AS_NO_DATA = true;
  const NO_DATA_PATTERNS = [/IndexError/i, /list index out of range/i, /moving_avg/i, /sqlclasses\.py/i];
  // -------------------------------------------------------------------------

  function ensureGraphSlot(form) {
    let slot = form.parentElement.querySelector('.graph-slot');
    if (!slot) {
      slot = document.createElement('div');
      slot.className = 'graph-slot';
      form.insertAdjacentElement('afterend', slot);
    }
    return slot;
  }

  function renderHtmlIntoSlot(slot, html) {
    slot.innerHTML = '';
    const srcdoc = html.includes('<base')
      ? html
      : html.replace('<head>', `<head><base href="${window.location.origin}/">`);

    const iframe = document.createElement('iframe');
    iframe.className = 'graph-frame';
    iframe.title = 'Graph';
    iframe.srcdoc = srcdoc;
    slot.appendChild(iframe);

    function resize() {
      try {
        const doc = iframe.contentDocument || iframe.contentWindow.document;
        const h = Math.max(
          doc.body.scrollHeight, doc.documentElement.scrollHeight,
          doc.body.offsetHeight, doc.documentElement.offsetHeight
        );
        iframe.style.height = Math.max(760, h) + 'px';
      } catch (_) {}
    }

    iframe.addEventListener('load', () => {
      const doc = iframe.contentDocument || iframe.contentWindow.document;

      let graphEl = doc.querySelector('.js-plotly-plot, .plotly-graph-div, #graph, #graph-container');

      let statsEl = null;
      if (graphEl) {
        statsEl =
          graphEl.parentElement?.querySelector('table') ||
          (graphEl.nextElementSibling && graphEl.nextElementSibling.tagName === 'TABLE'
            ? graphEl.nextElementSibling
            : null);
      }
      if (!statsEl) statsEl = doc.querySelector('table');

      if (graphEl) {
        const wrapper = doc.createElement('div');
        wrapper.style.maxWidth = '1200px';
        wrapper.style.margin = '0 auto';
        wrapper.style.padding = '8px 0 24px';
        wrapper.appendChild(graphEl);
        if (statsEl) wrapper.appendChild(statsEl);
        doc.body.innerHTML = '';
        doc.body.appendChild(wrapper);

        const style = doc.createElement('style');
        style.textContent = `
          html, body { height: 100%; margin: 0; }
          .plot-container.plotly { width: 100% !important; height: 100% !important; }
          .main-svg { width: 100% !important; }
          table { width: 100%; border-collapse: collapse; }
          table td, table th { padding: .5rem .75rem; }
        `;
        doc.head.appendChild(style);
      } else {
        const style = doc.createElement('style');
        style.textContent = `header, nav, .navbar, .Heading, .site-header, .site-footer, footer { display:none !important; }`;
        doc.head.appendChild(style);
      }

      resize();
      setTimeout(resize, 350);
      setTimeout(resize, 1200);
      window.addEventListener('resize', resize);
    });

    slot.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }

  async function probeHasData(form) {
    if (!ENABLE_PROBE) return { state: 'skip' };

    const action = form.getAttribute('action') || window.location.pathname;
    const fd = new FormData(form);
    fd.append('check_only', '1');

    try {
      const resp = await fetch(action, {
        method: 'POST',
        body: new URLSearchParams(fd),
        credentials: 'same-origin',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
          'X-Requested-With': 'XMLHttpRequest'
        },
        redirect: 'manual'
      });

      if (resp.status === 200) return { state: 'hasData', html: await resp.text() };

      if (resp.status >= 500) {
        if (TREAT_ALL_500_AS_NO_DATA) return { state: 'empty' };
        const text = await resp.text().catch(() => '');
        const looksNoData = NO_DATA_PATTERNS.some(rx => rx.test(text));
        return looksNoData ? { state: 'empty' } : { state: 'serverError', status: resp.status, html: text };
      }

      return { state: 'unknown', status: resp.status, html: await resp.text().catch(() => '') };
    } catch (err) {
      return { state: 'networkError', error: err };
    }
  }

  function attachHandlers(form) {
    const startInput = form.querySelector('input[name="start-date"]');
    const endInput   = form.querySelector('input[name="end-date"]');
    const datasetSel = form.querySelector('select[name="data2see"]');
    const locationEl = form.querySelector('input[name="location"]');

    const ensureMsg = (cls) => {
      let el = form.querySelector('.' + cls);
      if (!el) {
        el = document.createElement('p');
        el.className = cls;
        el.style.cssText = 'color:#B00020;margin-top:6px;font-weight:500;display:none;';
        endInput.insertAdjacentElement('afterend', el);
      }
      return el;
    };

    const dateError   = ensureMsg('date-error');
    const nodataError = ensureMsg('nodata-error');
    const serverError = ensureMsg('server-error');

    const clearMsgs = () => {
      [dateError, nodataError, serverError].forEach(el => { el.textContent=''; el.style.display='none'; });
    };

    function validateDates() {
      clearMsgs();
      if (!startInput.value || !endInput.value) return false;
      const s = normDate(startInput.value);
      const e = normDate(endInput.value);
      if (s > today) { dateError.textContent = '⚠️ Start date cannot be in the future.'; dateError.style.display='block'; return false; }
      if (e > today) { dateError.textContent = '⚠️ End date cannot be in the future.';   dateError.style.display='block'; return false; }
      if (s > e)     { dateError.textContent = '⚠️ Start date must be earlier than end date.'; dateError.style.display='block'; return false; }
      return true;
    }

    // --- NEW: "Current Data" button handler (last month → today) ------------
    const currentBtn =
      Array.from(form.querySelectorAll('button[type="button"], button:not([type])'))
        .find(b => /current\s*data/i.test(b.textContent || ''));

    if (currentBtn) {
      currentBtn.addEventListener('click', () => {
        // End = today
        const end = new Date(); end.setHours(0,0,0,0);
        // Start = one calendar month before today (handles month length correctly)
        const start = new Date(end);
        start.setMonth(start.getMonth() - 1);

        // Fill inputs in ISO yyyy-mm-dd
        endInput.value = isoDate(end);
        startInput.value = isoDate(start);

        // If user hasn’t chosen a metric yet, pick the first non-disabled option
        if (!datasetSel.value) {
          const firstReal = Array.from(datasetSel.options).find(opt => !opt.disabled && opt.value);
          if (firstReal) datasetSel.value = firstReal.value;
        }

        // Fire normal submit path (your probe + iframe render will run)
        form.requestSubmit();
      });
    }
    // ------------------------------------------------------------------------

    form.addEventListener('submit', async (e) => {
      if (!form.checkValidity()) return;
      if (!validateDates()) { e.preventDefault(); return; }

      e.preventDefault();
      const slot = ensureGraphSlot(form);
      slot.innerHTML = '<div class="graph-loading">Loading…</div>';

      const res = await probeHasData(form);
      clearMsgs();

      if (res.state === 'empty') {
        const loc = (locationEl?.value || '').replace(/\s+(ND|SD)$/i, '');
        slot.innerHTML = '';
        nodataError.textContent = `ℹ️ No data for "${datasetSel.value}" at ${loc} in that date range.`;
        nodataError.style.display = 'block';
        return;
      }

      if (res.state === 'serverError') {
        slot.innerHTML = '';
        serverError.textContent = `⚠️ Server error while generating the graph (${res.status}).`;
        serverError.style.display = 'block';
        return;
      }

      if (res.state === 'networkError') {
        slot.innerHTML = '';
        serverError.textContent = '⚠️ Network error while requesting the graph.';
        serverError.style.display = 'block';
        return;
      }

      if (res.state === 'hasData' && res.html) {
        renderHtmlIntoSlot(slot, res.html);
        return;
      }

      const action = form.getAttribute('action') || window.location.pathname;
      const fd = new FormData(form);

      try {
        const resp = await fetch(action, {
          method: 'POST',
          body: new URLSearchParams(fd),
          credentials: 'same-origin',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
            'X-Requested-With': 'XMLHttpRequest'
          },
          redirect: 'manual'
        });

        const html = await resp.text();
        if (resp.status === 200) {
          renderHtmlIntoSlot(slot, html);
        } else if (resp.status >= 500 && TREAT_ALL_500_AS_NO_DATA) {
          slot.innerHTML = '';
          nodataError.textContent = 'ℹ️ No data for the selected range.';
          nodataError.style.display = 'block';
        } else {
          slot.innerHTML = '';
          serverError.textContent = `⚠️ Could not render graph (${resp.status}).`;
          serverError.style.display = 'block';
        }
      } catch (err) {
        slot.innerHTML = '';
        serverError.textContent = '⚠️ Network error while requesting the graph.';
        serverError.style.display = 'block';
      }
    });
  }

  document.querySelectorAll('section form[action="/customgaugegraph/"]').forEach(attachHandlers);
});
</script>






<div class="tab-container">
<main>

  <!-- Tabs (one per location) -->
  <input id="tab1" type="radio" name="tabs" checked>
  <label for="tab1">Hazen</label>

  <input id="tab2" type="radio" name="tabs">
  <label for="tab2">Stanton</label>

  <input id="tab3" type="radio" name="tabs">
  <label for="tab3">Washburn</label>

  <input id="tab4" type="radio" name="tabs">
  <label for="tab4">Price</label>

  <input id="tab5" type="radio" name="tabs">
  <label for="tab5">Bismarck</label>

  <input id="tab6" type="radio" name="tabs">
  <label for="tab6">Schmidt</label>

  <input id="tab7" type="radio" name="tabs">
  <label for="tab7">Judson</label>

  <input id="tab8" type="radio" name="tabs">
  <label for="tab8">Mandan</label>

  <input id="tab9" type="radio" name="tabs">
  <label for="tab9">Breien</label>

  <input id="tab10" type="radio" name="tabs">
  <label for="tab10">Wakpala</label>

  <input id="tab11" type="radio" name="tabs">
  <label for="tab11">Little Eagle</label>

  <input id="tab12" type="radio" name="tabs">
  <label for="tab12">Cash</label>

  <input id="tab13" type="radio" name="tabs">
  <label for="tab13">Whitehorse</label>


  <!-- Hazen -->
  <section id="content1">
    <form action="/customgaugegraph/" method="POST">
      {% csrf_token %}
      <h3>Hazen, ND</h3>
      <select required name="data2see">
        <option value="" disabled selected>Choose Data Point</option>
        <option value="Gauge Height">Gauge Height</option>
        <option value="Elevation">Elevation</option>
        <option value="Discharge">Discharge</option>
        <option value="Water Temperature">Water Temperature</option>
      </select>
      <br><br>
      <h6>Enter Start and End Dates</h6>
      <input type="date" name="start-date" required>
      <input type="date" name="end-date" required>
      <input type="hidden" name="location" value="Hazen ND">
      <br><br>
      <button type="submit">Submit</button>
      <button type="button">Current Data</button>
    </form>
  </section>

  <!-- Stanton -->
  <section id="content2">
    <form action="/customgaugegraph/" method="POST">
      {% csrf_token %}
      <h3>Stanton, ND</h3>
      <select required name="data2see">
        <option value="" disabled selected>Choose Data Point</option>
        <option value="Gauge Height">Gauge Height</option>
        <option value="Elevation">Elevation</option>
        <option value="Discharge">Discharge</option>
        <option value="Water Temperature">Water Temperature</option>
      </select>
      <br><br>
      <h6>Enter Start and End Dates</h6>
      <input type="date" name="start-date" required>
      <input type="date" name="end-date" required>
      <input type="hidden" name="location" value="Stanton ND">
      <br><br>
      <button type="submit">Submit</button>
      <button type="button">Current Data</button>
    </form>
  </section>

  <!-- Washburn -->
  <section id="content3">
    <form action="/customgaugegraph/" method="POST">
      {% csrf_token %}
      <h3>Washburn, ND</h3>
      <select required name="data2see">
        <option value="" disabled selected>Choose Data Point</option>
        <option value="Gauge Height">Gauge Height</option>
        <option value="Elevation">Elevation</option>
        <option value="Discharge">Discharge</option>
        <option value="Water Temperature">Water Temperature</option>
      </select>
      <br><br>
      <h6>Enter Start and End Dates</h6>
      <input type="date" name="start-date" required>
      <input type="date" name="end-date" required>
      <input type="hidden" name="location" value="Washburn ND">
      <br><br>
      <button type="submit">Submit</button>
      <button type="button">Current Data</button>
    </form>
  </section>

  <!-- Price -->
  <section id="content4">
    <form action="/customgaugegraph/" method="POST">
      {% csrf_token %}
      <h3>Price, ND</h3>
      <select required name="data2see">
        <option value="" disabled selected>Choose Data Point</option>
        <option value="Gauge Height">Gauge Height</option>
        <option value="Elevation">Elevation</option>
        <option value="Discharge">Discharge</option>
        <option value="Water Temperature">Water Temperature</option>
      </select>
      <br><br>
      <h6>Enter Start and End Dates</h6>
      <input type="date" name="start-date" required>
      <input type="date" name="end-date" required>
      <input type="hidden" name="location" value="Price ND">
      <br><br>
      <button type="submit">Submit</button>
      <button type="button">Current Data</button>
    </form>
  </section>

  <!-- Bismarck -->
  <section id="content5">
    <form action="/customgaugegraph/" method="POST">
      {% csrf_token %}
      <h3>Bismarck, ND</h3>
      <select required name="data2see">
        <option value="" disabled selected>Choose Data Point</option>
        <option value="Gauge Height">Gauge Height</option>
        <option value="Elevation">Elevation</option>
        <option value="Discharge">Discharge</option>
        <option value="Water Temperature">Water Temperature</option>
      </select>
      <br><br>
      <h6>Enter Start and End Dates</h6>
      <input type="date" name="start-date" required>
      <input type="date" name="end-date" required>
      <input type="hidden" name="location" value="Bismarck ND">
      <br><br>
      <button type="submit">Submit</button>
      <button type="button">Current Data</button>
    </form>
  </section>

  <!-- Schmidt -->
  <section id="content6">
    <form action="/customgaugegraph/" method="POST">
      {% csrf_token %}
      <h3>Schmidt, ND</h3>
      <select required name="data2see">
        <option value="" disabled selected>Choose Data Point</option>
        <option value="Gauge Height">Gauge Height</option>
        <option value="Elevation">Elevation</option>
        <option value="Discharge">Discharge</option>
        <option value="Water Temperature">Water Temperature</option>
      </select>
      <br><br>
      <h6>Enter Start and End Dates</h6>
      <input type="date" name="start-date" required>
      <input type="date" name="end-date" required>
      <input type="hidden" name="location" value="Schmidt ND">
      <br><br>
      <button type="submit">Submit</button>
      <button type="button">Current Data</button>
    </form>
  </section>

  <!-- Judson -->
  <section id="content7">
    <form action="/customgaugegraph/" method="POST">
      {% csrf_token %}
      <h3>Judson, ND</h3>
      <select required name="data2see">
        <option value="" disabled selected>Choose Data Point</option>
        <option value="Gauge Height">Gauge Height</option>
        <option value="Elevation">Elevation</option>
        <option value="Discharge">Discharge</option>
        <option value="Water Temperature">Water Temperature</option>
      </select>
      <br><br>
      <h6>Enter Start and End Dates</h6>
      <input type="date" name="start-date" required>
      <input type="date" name="end-date" required>
      <input type="hidden" name="location" value="Judson ND">
      <br><br>
      <button type="submit">Submit</button>
      <button type="button">Current Data</button>
    </form>
  </section>

  <!-- Mandan -->
  <section id="content8">
    <form action="/customgaugegraph/" method="POST">
      {% csrf_token %}
      <h3>Mandan, ND</h3>
      <select required name="data2see">
        <option value="" disabled selected>Choose Data Point</option>
        <option value="Gauge Height">Gauge Height</option>
        <option value="Elevation">Elevation</option>
        <option value="Discharge">Discharge</option>
        <option value="Water Temperature">Water Temperature</option>
      </select>
      <br><br>
      <h6>Enter Start and End Dates</h6>
      <input type="date" name="start-date" required>
      <input type="date" name="end-date" required>
      <input type="hidden" name="location" value="Mandan ND">
      <br><br>
      <button type="submit">Submit</button>
      <button type="button">Current Data</button>
    </form>
  </section>

  <!-- Breien -->
  <section id="content9">
    <form action="/customgaugegraph/" method="POST">
      {% csrf_token %}
      <h3>Breien, ND</h3>
      <select required name="data2see">
        <option value="" disabled selected>Choose Data Point</option>
        <option value="Gauge Height">Gauge Height</option>
        <option value="Elevation">Elevation</option>
        <option value="Discharge">Discharge</option>
        <option value="Water Temperature">Water Temperature</option>
      </select>
      <br><br>
      <h6>Enter Start and End Dates</h6>
      <input type="date" name="start-date" required>
      <input type="date" name="end-date" required>
      <input type="hidden" name="location" value="Breien ND">
      <br><br>
      <button type="submit">Submit</button>
      <button type="button">Current Data</button>
    </form>
  </section>

  <!-- Wakpala -->
  <section id="content10">
    <form action="/customgaugegraph/" method="POST">
      {% csrf_token %}
      <h3>Wakpala, SD</h3>
      <select required name="data2see">
        <option value="" disabled selected>Choose Data Point</option>
        <option value="Gauge Height">Gauge Height</option>
        <option value="Elevation">Elevation</option>
        <option value="Discharge">Discharge</option>
        <option value="Water Temperature">Water Temperature</option>
      </select>
      <br><br>
      <h6>Enter Start and End Dates</h6>
      <input type="date" name="start-date" required>
      <input type="date" name="end-date" required>
      <input type="hidden" name="location" value="Wakpala SD">
      <br><br>
      <button type="submit">Submit</button>
      <button type="button">Current Data</button>
    </form>
  </section>

  <!-- Little Eagle -->
  <section id="content11">
    <form action="/customgaugegraph/" method="POST">
      {% csrf_token %}
      <h3>Little Eagle, SD</h3>
      <select required name="data2see">
        <option value="" disabled selected>Choose Data Point</option>
        <option value="Gauge Height">Gauge Height</option>
        <option value="Elevation">Elevation</option>
        <option value="Discharge">Discharge</option>
        <option value="Water Temperature">Water Temperature</option>
      </select>
      <br><br>
      <h6>Enter Start and End Dates</h6>
      <input type="date" name="start-date" required>
      <input type="date" name="end-date" required>
      <input type="hidden" name="location" value="Little Eagle SD">
      <br><br>
      <button type="submit">Submit</button>
      <button type="button">Current Data</button>
    </form>
  </section>

  <!-- Cash -->
  <section id="content12">
    <form action="/customgaugegraph/" method="POST">
      {% csrf_token %}
      <h3>Cash, SD</h3>
      <select required name="data2see">
        <option value="" disabled selected>Choose Data Point</option>
        <option value="Gauge Height">Gauge Height</option>
        <option value="Elevation">Elevation</option>
        <option value="Discharge">Discharge</option>
        <option value="Water Temperature">Water Temperature</option>
      </select>
      <br><br>
      <h6>Enter Start and End Dates</h6>
      <input type="date" name="start-date" required>
      <input type="date" name="end-date" required>
      <input type="hidden" name="location" value="Cash SD">
      <br><br>
      <button type="submit">Submit</button>
      <button type="button">Current Data</button>
    </form>
  </section>

  <!-- Whitehorse -->
  <section id="content13">
    <form action="/customgaugegraph/" method="POST">
      {% csrf_token %}
      <h3>Whitehorse, SD</h3>
      <select required name="data2see">
        <option value="" disabled selected>Choose Data Point</option>
        <option value="Gauge Height">Gauge Height</option>
        <option value="Elevation">Elevation</option>
        <option value="Discharge">Discharge</option>
        <option value="Water Temperature">Water Temperature</option>
      </select>
      <br><br>
      <h6>Enter Start and End Dates</h6>
      <input type="date" name="start-date" required>
      <input type="date" name="end-date" required>
      <input type="hidden" name="location" value="Whitehorse SD">
      <br><br>
      <button type="submit">Submit</button>
      <button type="button">Current Data</button>
    </form>
  </section>

</main>
</div>
</body>
</html>

